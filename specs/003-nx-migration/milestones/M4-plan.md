<!--
==============================================================================
DOCUMENT PURPOSE: Implementation Plan for M4: Components as Nx Projects
==============================================================================

This plan describes HOW to implement M4 requirements from spec.md.
It bridges the gap between "what we need" (spec) and "what we do" (tasks).

FOCUS: HOW
- How to configure each component as an Nx project
- What configuration patterns to use
- How files should be organized

AUTOMATION:
- Auto-generated by `/speckit.plan` from M4 specification
- Feeds into `/speckit.tasks` for task generation

VALIDATION:
- Every spec requirement should have implementation guidance
- Configuration examples should be complete and executable
- Patterns should be consistent across all packages
==============================================================================
-->

# Implementation Plan: M4 - Components as Nx Projects

**Package Branch**: `feat/m4-components-as-nx-projects`
**Date**: 2026-01-28
**Spec**: `/specs/003-nx-migration/spec.md` (Milestone 4)
**Input**: M4 specification - convert all 96 packages to Nx projects

## Summary

Convert all Backpack component packages into Nx projects by adding `project.json` files. This enables:
- `nx affected` for incremental builds (only build/test changed projects)
- Computation caching for faster CI
- Precise dependency graph visualization
- Project-level task execution

**Approach**: Generate minimal `project.json` files with project metadata and tags. Defer target configuration to M5 (Static Checks via Nx).

## Technical Context

**Build System**: Nx 22.4.2 (already initialized in M1)
**Package Count**: 96 packages in `packages/` directory
**Existing Structure**: Each package has `src/`, `index.ts`, `README.md`
**Current State**: Nx recognizes only root `backpack` project

**Constraints**:
- Must not break existing `npm run` scripts
- Must not change consumer import paths
- Must maintain existing TypeScript compilation
- Must work with existing Jest configuration

## Constitution Check

*GATE: Must pass before implementation begins.*

- [x] **Monorepo Architecture**: Adding project.json maintains existing structure
- [x] **No Breaking Changes**: Consumer imports unchanged
- [x] **Existing Scripts**: All `npm run` commands continue working
- [x] **TypeScript**: No changes to TypeScript compilation
- [x] **Test Coverage**: Test infrastructure unchanged
- [x] **Documentation**: Migration documented in this plan

## Project Configuration Strategy

### Minimal project.json Approach

For M4, use **minimal configuration** - only project metadata, no targets.

**Rationale**:
- Targets will be added in M5 (Static Checks via Nx)
- Minimal config enables `nx affected` and `nx graph` immediately
- Reduces risk of breaking existing build pipeline
- Faster implementation and easier rollback

### project.json Structure

```json
{
  "name": "bpk-component-button",
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "sourceRoot": "packages/bpk-component-button/src",
  "projectType": "library",
  "tags": ["scope:component", "type:lib"],
  "targets": {}
}
```

**Field Explanations**:

| Field | Value | Purpose |
|-------|-------|---------|
| `name` | Package name | Unique project identifier |
| `$schema` | Nx schema path | IDE autocomplete support |
| `sourceRoot` | `packages/{name}/src` | Source code location |
| `projectType` | `library` | Identifies as publishable library |
| `tags` | `["scope:component", "type:lib"]` | Enables module boundary rules (M6) |
| `targets` | `{}` | Empty - targets added in M5 |

### Project Tags Strategy

Tags enable module boundary enforcement in M6. Use two-dimensional tagging:

**Scope Tags** (what domain):
- `scope:component` - UI components (bpk-component-*)
- `scope:util` - Utilities (bpk-react-utils, bpk-scrim-utils)
- `scope:foundation` - Foundations (bpk-mixins, bpk-theming)
- `scope:style` - Stylesheets (bpk-stylesheets)

**Type Tags** (what kind):
- `type:lib` - Library packages
- `type:util` - Utility packages

### Tag Assignment Logic

```text
if package.startsWith("bpk-component-"):
  tags = ["scope:component", "type:lib"]
elif package in ["bpk-react-utils", "bpk-scrim-utils"]:
  tags = ["scope:util", "type:util"]
elif package in ["bpk-mixins", "bpk-theming"]:
  tags = ["scope:foundation", "type:lib"]
elif package == "bpk-stylesheets":
  tags = ["scope:style", "type:lib"]
else:
  tags = ["scope:component", "type:lib"]  # default
```

## File Structure

### Before M4

```text
packages/
├── bpk-component-button/
│   ├── README.md
│   ├── index.ts
│   └── src/
│       ├── BpkButton.tsx
│       └── BpkButton-test.tsx
└── ...
```

### After M4

```text
packages/
├── bpk-component-button/
│   ├── README.md
│   ├── index.ts
│   ├── project.json          ← NEW
│   └── src/
│       ├── BpkButton.tsx
│       └── BpkButton-test.tsx
└── ...
```

## Implementation Scripts

### Generator Script

Location: `scripts/generate-nx-projects.sh`

```bash
#!/usr/bin/env bash
# Generate project.json files for all packages
set -e

TEMPLATE_DIR="scripts/templates"
PACKAGES_DIR="packages"

for pkg in "$PACKAGES_DIR"/bpk-*; do
  if [ -d "$pkg" ]; then
    pkg_name=$(basename "$pkg")
    project_file="$pkg/project.json"

    if [ ! -f "$project_file" ]; then
      echo "Creating project.json for $pkg_name..."
      sed "s/{{PACKAGE_NAME}}/$pkg_name/g" \
          "$TEMPLATE_DIR/project.json.template" > "$project_file"
    fi
  fi
done
```

### Template File

Location: `scripts/templates/project.json.template`

```json
{
  "name": "{{PACKAGE_NAME}}",
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "sourceRoot": "packages/{{PACKAGE_NAME}}/src",
  "projectType": "library",
  "tags": ["scope:component", "type:lib"],
  "targets": {}
}
```

## Verification Commands

### Check Project Count

```bash
# Should output 96 (or 97 with root project)
nx show projects | wc -l
```

### Verify Specific Project

```bash
# Should show project configuration
nx show project bpk-component-button --json
```

### Test Affected Detection

```bash
# After modifying a file in bpk-component-button
nx show projects --affected --base=HEAD~1
# Should list bpk-component-button and dependents
```

### Generate Dependency Graph

```bash
nx graph
# Opens browser with interactive dependency visualization
```

## TypeScript Configuration (Deferred)

**Note**: TypeScript project references (`tsconfig.lib.json`, `tsconfig.spec.json`) are **deferred to M5**.

**Rationale**:
- M4 focus is project registration only
- TypeScript config changes risk breaking existing `.d.ts` generation
- M5 will add targets that require TypeScript configuration

## Dependencies

### Milestone Dependencies

| Dependency | Status | Required For |
|------------|--------|--------------|
| M1: Nx Initialization | ✅ Complete | Nx CLI available |
| M3: Storybook Colocation | ✅ Complete | Stories in correct location |

### External Dependencies

- Nx 22.4.2 (installed)
- Node.js >=18.20.4 (project requirement)
- npm >=10.7.0 (project requirement)

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Invalid JSON syntax | Projects not recognized | Low | JSON validation in script |
| Schema path incorrect | IDE autocomplete broken | Low | Use relative path `../../node_modules/` |
| Tag typo | Module boundary rules fail | Low | Validate tags in script |
| Nx cache stale | Projects not visible | Medium | Run `nx reset` if issues |

## Rollback Plan

If M4 causes issues:

```bash
# Remove all project.json files
find packages -name "project.json" -delete

# Reset Nx cache
nx reset

# Verify rollback
nx show projects  # Should only show "backpack"
```

## Success Criteria

- [ ] All 96 packages have `project.json`
- [ ] `nx show projects` lists all 96+ projects
- [ ] `nx graph` generates dependency visualization
- [ ] `nx show projects --affected` works correctly
- [ ] All existing `npm run` commands work unchanged
- [ ] No changes to consumer import paths

## Next Steps (M5)

After M4 is complete, M5 will:
1. Add `lint` target to all project.json files
2. Add `test` target to all project.json files
3. Add `typecheck` target to all project.json files
4. Update CI to use `nx affected`
5. Enable computation caching

## References

- **M4 Specification**: `specs/003-nx-migration/spec.md` (Milestone 4 section)
- **Nx Project Configuration**: [Nx Docs](https://nx.dev/reference/project-configuration)
- **Nx Affected**: [Nx Affected Commands](https://nx.dev/ci/features/affected)
- **Module Boundaries**: [Nx Enforce Module Boundaries](https://nx.dev/features/enforce-module-boundaries)
