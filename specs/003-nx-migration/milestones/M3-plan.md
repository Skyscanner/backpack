<!--
==============================================================================
DOCUMENT PURPOSE: Implementation Plan for M3: Storybook Colocation
==============================================================================

This plan describes the technical implementation for Milestone 3 of the Nx
migration - moving Storybook stories from examples/ to packages/.

FOCUS: HOW to colocate stories
- What files to move
- How to update configuration
- How to verify success

AUTOMATION:
- Auto-generated by `/speckit.plan` from M3-storybook-colocation.md
- Feeds into `/speckit.tasks` for task generation
==============================================================================
-->

# Implementation Plan: M3 - Storybook Colocation

**Package Branch**: `003-nx-migration` | **Date**: 2026-01-27
**Spec**: [M3-storybook-colocation.md](M3-storybook-colocation.md)
**Research**: [M3-research.md](M3-research.md)

## Summary

Move Storybook stories from the separate `examples/` directory to colocate with their respective components in `packages/`. This improves developer experience, enables better Nx dependency analysis, and follows modern Storybook best practices.

**Key Principle**: All stories must render correctly after migration. Zero visual regressions.

## Technical Context

**Current Stack**:
- **Storybook**: 10.1.x with React-Webpack5
- **Build**: Webpack 5 via @storybook/react-webpack5
- **Config**: `.storybook/main.ts`

**Migration Scope**:
- **92 example directories** to migrate
- **~184 files** (stories.tsx + examples.tsx per component)
- **~100 style files** (*.module.scss)

**What M3 Changes**:
- Story file locations
- Storybook configuration glob pattern
- Import paths within story files

## Constitution Check

*GATE: Must pass before implementation begins.*

### Migration-Specific Compliance

- [x] **Non-Breaking**: No changes to consumer import paths
- [x] **Existing Scripts**: `npm run storybook` continues working
- [x] **CI Pipeline**: Storybook deployment unchanged (after config update)
- [x] **Package Structure**: Follows Backpack monorepo conventions
- [x] **License Headers**: All moved files retain license headers
- [x] **Documentation**: Stories remain accessible in Storybook UI

### Backpack Constitution Alignment

- [x] **Component-First**: Stories colocated with components
- [x] **Naming Conventions**: Story files keep existing names
- [x] **Test Coverage**: Visual regression tests still work
- [x] **Documentation Standards**: Storybook stories remain primary docs

## Project Structure

### Before Migration

```text
backpack/
├── examples/
│   ├── bpk-component-button/
│   │   ├── stories.tsx
│   │   ├── examples.tsx
│   │   └── BpkButtonStory.module.scss
│   ├── bpk-component-card/
│   │   ├── stories.tsx
│   │   ├── examples.tsx
│   │   └── BpkCardStory.module.scss
│   └── ... (92 directories)
└── packages/
    ├── bpk-component-button/
    │   └── src/
    │       └── BpkButton/
    │           └── BpkButton.tsx
    └── ...
```

### After Migration

```text
backpack/
├── examples/               ← REMOVED (empty)
└── packages/
    ├── bpk-component-button/
    │   └── src/
    │       ├── BpkButton/
    │       │   └── BpkButton.tsx
    │       ├── stories.tsx         ← MOVED HERE
    │       ├── examples.tsx        ← MOVED HERE
    │       └── BpkButtonStory.module.scss  ← MOVED HERE
    └── ...
```

## Implementation Approach

### Phase 1: Preparation

**Objective**: Establish baseline and create migration tooling

1. **Count Current Stories**
   ```bash
   find examples -name "stories.tsx" | wc -l
   # Expected: 92
   ```

2. **Verify Storybook Works Before Migration**
   ```bash
   npm run storybook:dist
   # Should complete successfully
   ```

3. **Create Migration Script**

   Create `scripts/migrate-stories.sh`:
   ```bash
   #!/usr/bin/env bash
   # Migrate stories from examples/ to packages/

   for dir in examples/bpk-*; do
     component=$(basename "$dir")
     target="packages/$component/src"

     if [ -d "$target" ]; then
       echo "Moving $component stories..."

       # Move story files
       [ -f "$dir/stories.tsx" ] && mv "$dir/stories.tsx" "$target/"
       [ -f "$dir/examples.tsx" ] && mv "$dir/examples.tsx" "$target/"

       # Move style files
       for scss in "$dir"/*.module.scss "$dir"/*.module.css; do
         [ -f "$scss" ] && mv "$scss" "$target/"
       done
     fi
   done
   ```

### Phase 2: Migration Execution

**Objective**: Move all story files to their new locations

1. **Run Migration Script**
   ```bash
   chmod +x scripts/migrate-stories.sh
   ./scripts/migrate-stories.sh
   ```

2. **Update Import Paths in Stories**

   Each story file needs import path updates:

   **Before** (examples/bpk-component-button/stories.tsx):
   ```typescript
   import BpkButton from '../../packages/bpk-component-button';
   ```

   **After** (packages/bpk-component-button/src/stories.tsx):
   ```typescript
   import BpkButton from '../index';
   // or for direct component import:
   import BpkButton from './BpkButton';
   ```

3. **Update Example Imports Similarly**

   **Before** (examples/bpk-component-button/examples.tsx):
   ```typescript
   import BpkButton from '../../packages/bpk-component-button';
   ```

   **After** (packages/bpk-component-button/src/examples.tsx):
   ```typescript
   import BpkButton from '../index';
   ```

### Phase 3: Configuration Update

**Objective**: Update Storybook to find stories in new location

1. **Update `.storybook/main.ts`**

   **Before**:
   ```typescript
   const config: StorybookConfig = {
     stories: [
       '../examples/**/stories.@(ts|tsx|js|jsx)',
     ],
     // ...
   };
   ```

   **After**:
   ```typescript
   const config: StorybookConfig = {
     stories: [
       '../packages/**/src/stories.@(ts|tsx|js|jsx)',
     ],
     // ...
   };
   ```

2. **Update Nx Plugin Configuration** (if needed)

   Check `nx.json` storybook plugin options are still valid.

### Phase 4: Import Path Automation

**Objective**: Automatically fix import paths in all moved files

1. **Create Import Fix Script**

   ```bash
   # scripts/fix-story-imports.sh

   for story in packages/*/src/stories.tsx; do
     # Replace ../../packages/bpk-component-X with ../index
     sed -i '' "s|from '../../packages/bpk-[^']*'|from '../index'|g" "$story"
   done

   for example in packages/*/src/examples.tsx; do
     sed -i '' "s|from '../../packages/bpk-[^']*'|from '../index'|g" "$example"
   done
   ```

2. **Handle Style Imports**

   Story styles may import from component styles:
   ```scss
   // Before
   @use '../../../packages/bpk-component-button/src/BpkButton/BpkButton.module';

   // After
   @use './BpkButton/BpkButton.module';
   ```

### Phase 5: Verification

**Objective**: Ensure all stories work correctly

1. **Verify Story Count**
   ```bash
   find packages -path "*/src/stories.tsx" | wc -l
   # Expected: 92
   ```

2. **Build Storybook**
   ```bash
   npm run storybook:dist
   ```

3. **Run Storybook Dev Server**
   ```bash
   npm run storybook
   # Manually verify stories render
   ```

4. **Run Percy Visual Tests** (if available)
   ```bash
   npm run percy-test
   ```

### Phase 6: Cleanup

**Objective**: Remove old examples directory and update docs

1. **Remove Empty Examples Directory**
   ```bash
   rm -rf examples/
   ```

2. **Update Git History** (optional, for cleaner history)
   ```bash
   git add -A
   git commit -m "chore(storybook): colocate stories with components (M3)"
   ```

3. **Update Documentation**
   - Update CONTRIBUTING.md if it references examples/
   - Update any README files mentioning story locations

## Testing Strategy

### Verification Tests

| Test | Command | Expected Result |
|------|---------|-----------------|
| Story count | `find packages -path "*/src/stories.tsx" \| wc -l` | 92 |
| Storybook build | `npm run storybook:dist` | Success |
| Storybook dev | `npm run storybook` | All stories render |
| Percy tests | `npm run percy-test` | No visual regressions |
| TypeScript | `npm run typecheck` | No errors |
| Lint | `npm run lint` | No new errors |

### Manual Verification

1. Open Storybook in browser
2. Navigate through component categories
3. Verify all stories are visible
4. Check interactive controls work
5. Verify docs pages render correctly

## Rollback Plan

If issues arise after migration:

1. **Revert File Moves**
   ```bash
   git checkout HEAD~1 -- examples/ packages/
   ```

2. **Restore Storybook Config**
   ```bash
   git checkout HEAD~1 -- .storybook/main.ts
   ```

3. **Reinstall Dependencies**
   ```bash
   npm ci
   ```

## Dependencies

### Required Before M3

- **M1**: Nx Initialization (complete)
- **M2**: Project Structure Confirmation (optional but helpful)

### Blocks After M3

- **M4**: Components as Nx Projects (stories should be colocated first)

## Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Import paths break | Storybook fails to build | High | Automated import fix script |
| Missing stories | Documentation gaps | Medium | Count verification before/after |
| Style imports break | Visual bugs | Medium | Update relative paths |
| Percy baseline shift | CI failures | Low | Update Percy baselines if needed |

## Success Criteria

Before merging, verify ALL pass:

- [ ] All 92 story directories migrated
- [ ] `npm run storybook:dist` succeeds
- [ ] All stories visible in Storybook UI
- [ ] No visual regressions (Percy)
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes
- [ ] `examples/` directory removed
- [ ] `.storybook/main.ts` updated
- [ ] CI pipeline passes

## Release Checklist

- [ ] Migration script tested on sample components
- [ ] All stories moved to packages/*/src/
- [ ] Import paths updated in all story files
- [ ] Storybook config updated
- [ ] Storybook builds successfully
- [ ] All stories render correctly
- [ ] examples/ directory removed
- [ ] Documentation updated
- [ ] PR reviewed and approved
- [ ] CI passes

## Notes

### What M3 Does NOT Do

- Does NOT change component implementation
- Does NOT change component APIs
- Does NOT affect published package
- Does NOT require consumer changes

### Key Patterns to Follow

1. **Story Location**: `packages/bpk-component-*/src/stories.tsx`
2. **Example Location**: `packages/bpk-component-*/src/examples.tsx`
3. **Style Location**: `packages/bpk-component-*/src/*Story.module.scss`
4. **Import Pattern**: `import Component from '../index'`

### Common Pitfalls to Avoid

1. ❌ Moving stories inside component subdirectory → ✅ Keep at src/ level
2. ❌ Changing story file names → ✅ Keep as stories.tsx
3. ❌ Forgetting style files → ✅ Move *.module.scss too
4. ❌ Manual file moves → ✅ Use automated script

## References

- **M3 Specification**: `specs/003-nx-migration/milestones/M3-storybook-colocation.md`
- **M3 Research**: `specs/003-nx-migration/milestones/M3-research.md`
- **Storybook Docs**: [Component Story Format](https://storybook.js.org/docs/react/api/csf)
- **Nx Storybook**: [Nx Storybook Plugin](https://nx.dev/recipes/storybook/overview-react)
