<!--
==============================================================================
DOCUMENT PURPOSE: Implementation Plan for M1: Nx Initialization
==============================================================================

This plan describes the technical implementation for Milestone 1 of the Nx
migration. It provides step-by-step guidance for initializing Nx in the
Backpack repository.

FOCUS: HOW to initialize Nx
- What commands to run
- What files will be created
- How to verify success
- How to handle potential issues

AUTOMATION:
- Auto-generated by `/speckit.plan` from M1-nx-initialization.md
- Feeds into `/speckit.tasks` for task generation
==============================================================================
-->

# Implementation Plan: M1 - Nx Initialization

**Package Branch**: `003-nx-migration` | **Date**: 2026-01-27
**Spec**: [M1-nx-initialization.md](milestones/M1-nx-initialization.md)
**Research**: [M1-research.md](milestones/M1-research.md)

## Summary

Initialize an Nx workspace in the existing Backpack monorepo to enable task orchestration, dependency graph visualization, and caching capabilities. This is the foundational step that enables all subsequent Nx migration milestones.

**Key Principle**: Zero disruption to existing workflows. All current `npm run` commands must continue working unchanged.

## Technical Context

**Current Stack** (no changes in M1):
- **Framework**: React 18.3.1 with TypeScript 5.9.2
- **Build**: Gulp 5, Babel 7, npm-run-all
- **Testing**: Jest 30 + Testing Library
- **Linting**: ESLint, Stylelint
- **CI**: GitHub Actions

**What M1 Adds**:
- `nx.json` configuration file at repository root
- `nx` npm package in devDependencies
- Ability to run `nx graph` for dependency visualization
- Local computation caching

## Constitution Check

*GATE: Must pass before implementation begins.*

### Migration-Specific Compliance

- [x] **Non-Breaking**: No changes to consumer import paths (`@skyscanner/backpack-web/...`)
- [x] **Existing Scripts**: All `npm run` commands continue working unchanged
- [x] **CI Pipeline**: No modifications required to GitHub Actions
- [x] **Package Structure**: No folder restructuring in M1
- [x] **TypeScript**: Existing configuration preserved (no `composite: true`)
- [x] **Build Tools**: Gulp, Babel, Webpack remain unchanged
- [x] **Testing**: Jest configuration unchanged
- [x] **Documentation**: Migration documentation provided

### Backpack Constitution Principles

- [x] **Monorepo Architecture**: `packages/` structure preserved
- [x] **Naming Conventions**: No renames required
- [x] **License Headers**: No new source files requiring headers
- [x] **Modern Sass**: Sass setup unchanged
- [x] **Accessibility-First**: Testing infrastructure unchanged
- [x] **Test Coverage**: Coverage thresholds unchanged (70% branches, 75% functions)
- [x] **Versioning**: No version changes to `@skyscanner/backpack-web`

## Project Structure

### Files Created by M1

```text
backpack/
├── nx.json                    # NEW: Nx workspace configuration
├── package.json               # MODIFIED: nx added to devDependencies
├── package-lock.json          # MODIFIED: lockfile updated
└── .nx/                       # EXISTS: Nx cache and workspace data
    ├── cache/                 # Local computation cache
    └── workspace-data/        # Workspace metadata
```

### Documentation Structure

```text
specs/003-nx-migration/
├── spec.md                    # Full migration specification
├── plan.md                    # This file (M1 implementation plan)
├── milestones/
│   ├── M1-nx-initialization.md    # M1 requirements
│   ├── M1-research.md             # M1 research findings
│   └── ...                        # Other milestone specs
└── tasks.md                   # Generated by /speckit.tasks
```

## Implementation Approach

### Phase 1: Preparation

**Objective**: Ensure clean starting state and document baseline

1. **Branch Setup**
   ```bash
   git checkout main
   git pull origin main
   git checkout -b feat/nx-initialization
   ```

2. **Baseline Verification**
   - Run `npm run build` and verify success
   - Run `npm run test` and verify all tests pass
   - Run `npm run lint` and verify no errors
   - Run `npm run typecheck` and verify no errors
   - Document any existing issues before Nx initialization

3. **Environment Check**
   ```bash
   node --version  # Should be >=18.20.4
   npm --version   # Should be >=10.7.0
   ```

### Phase 2: Nx Initialization

**Objective**: Initialize Nx workspace with minimal configuration

1. **Run Nx Init Command**
   ```bash
   npx nx@latest init
   ```

2. **Expected Prompts and Answers**

   | Prompt | Recommended Answer | Rationale |
   |--------|-------------------|-----------|
   | "Enable distributed task execution?" | No | Not needed for M1 |
   | "Add Nx Cloud?" | No | Can add in future milestone |
   | "Wrap existing scripts?" | Yes | Enables Nx caching for npm scripts |

3. **Expected Changes**

   **New file: `nx.json`**
   ```json
   {
     "$schema": "./node_modules/nx/schemas/nx-schema.json",
     "defaultBase": "main",
     "targetDefaults": {
       "build": {
         "cache": true
       },
       "test": {
         "cache": true
       },
       "lint": {
         "cache": true
       }
     }
   }
   ```

   **Modified: `package.json`**
   ```json
   {
     "devDependencies": {
       "nx": "^XX.X.X"  // Latest version
     }
   }
   ```

### Phase 3: Verification

**Objective**: Verify Nx installation without disrupting existing workflows

1. **Verify Nx Installation**
   ```bash
   # Check nx is installed
   npx nx --version

   # Verify dependency graph generation
   npx nx graph
   ```

2. **Verify Existing Scripts Work**
   ```bash
   # These must all succeed with no changes
   npm run build
   npm run test
   npm run lint
   npm run typecheck
   npm run storybook:dist
   ```

3. **Verify CI Scripts Work**
   ```bash
   # Simulate CI workflow
   npm ci
   npm run build
   npm run typecheck
   npm run test
   ```

### Phase 4: Configuration Refinement

**Objective**: Optimize Nx configuration for Backpack's needs

1. **Review and Adjust `nx.json`**

   Recommended configuration for Backpack:
   ```json
   {
     "$schema": "./node_modules/nx/schemas/nx-schema.json",
     "defaultBase": "main",
     "namedInputs": {
       "default": ["{projectRoot}/**/*", "sharedGlobals"],
       "sharedGlobals": [
         "{workspaceRoot}/babel.config.js",
         "{workspaceRoot}/tsconfig.json"
       ],
       "production": [
         "default",
         "!{projectRoot}/**/?(*.)+(spec|test).[jt]s?(x)",
         "!{projectRoot}/**/*.stories.tsx"
       ]
     },
     "targetDefaults": {
       "build": {
         "cache": true,
         "dependsOn": ["^build"],
         "inputs": ["production", "^production"]
       },
       "test": {
         "cache": true,
         "inputs": ["default", "^default"]
       },
       "lint": {
         "cache": true,
         "inputs": ["default"]
       }
     }
   }
   ```

2. **Update `.gitignore`** (if not already present)
   ```gitignore
   # Nx
   .nx/cache
   ```

### Phase 5: Documentation

**Objective**: Document Nx usage for the team

1. **Update Repository Documentation**

   Add to `CONTRIBUTING.md` or create `docs/nx-migration.md`:
   ```markdown
   ## Nx Integration (M1)

   Backpack uses Nx for task orchestration and caching.

   ### Quick Start

   # View dependency graph
   npx nx graph

   # All existing npm scripts continue to work
   npm run build
   npm run test
   npm run lint

   ### Why Nx?

   - Faster CI with computation caching
   - Dependency graph visualization
   - Future: affected-based test execution
   ```

## Testing Strategy

### M1-Specific Testing

No new tests are required for M1. The verification is:

1. **Installation Test**: `npx nx --version` returns version number
2. **Graph Test**: `npx nx graph` opens dependency visualization
3. **Compatibility Test**: All existing npm scripts work unchanged

### Regression Testing

| Script | Expected Result |
|--------|-----------------|
| `npm run build` | Success, same output as before |
| `npm run test` | All tests pass |
| `npm run lint` | No errors |
| `npm run typecheck` | No errors |
| `npm run storybook:dist` | Storybook builds successfully |

## Rollback Plan

If issues arise after initialization:

1. **Immediate Rollback**
   ```bash
   # Revert all changes
   git checkout main -- package.json package-lock.json
   rm nx.json
   npm ci
   ```

2. **Full Branch Rollback**
   ```bash
   # If branch was merged, revert the merge commit
   git revert <merge-commit-sha>
   ```

3. **What Gets Removed**
   - `nx.json`
   - `nx` from devDependencies
   - `.nx/cache/` contents (can keep directory)

## Dependencies

### Internal Dependencies
- None (M1 is the first milestone)

### External Dependencies
- `nx` (npm package) - latest stable version
- Node.js >=18.20.4
- npm >=10.7.0

### Blocked By
- None

### Blocks
- M2: Project Structure Confirmation
- M3: Storybook Colocation
- M4: Components as Nx Projects
- M5: Static Checks via Nx
- M6: Module Boundaries

## Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Nx peer dependency conflict | Build failure | Low | Review dependency tree before committing |
| Existing scripts break | CI failure | Very Low | Test all scripts before merging |
| Git hooks affected | Dev workflow disruption | Very Low | Test pre-commit hooks |
| Package-lock changes | Merge conflicts | Medium | Coordinate with other PRs |

## Success Criteria

### Measurable Outcomes

- [ ] `nx.json` exists at repository root
- [ ] `npx nx --version` returns version number
- [ ] `npx nx graph` displays dependency visualization
- [ ] `npm run build` succeeds unchanged
- [ ] `npm run test` passes (same results as before)
- [ ] `npm run lint` passes (same results as before)
- [ ] `npm run typecheck` passes (same results as before)
- [ ] GitHub Actions CI pipeline passes
- [ ] No changes to consumer import paths

### Verification Commands

```bash
# All of these must succeed
npx nx --version
npx nx graph
npm run build
npm run test
npm run lint
npm run typecheck
```

## Release Checklist

Before merging M1:

- [ ] Feature branch created from `main`
- [ ] `npx nx@latest init` completed
- [ ] `nx.json` reviewed and committed
- [ ] All existing npm scripts verified working
- [ ] CI pipeline passes
- [ ] PR reviewed by team member
- [ ] Documentation updated
- [ ] No breaking changes to consumers

## Notes

### What M1 Does NOT Do

- Does NOT add `project.json` files to components (M4)
- Does NOT enable `nx affected` (M4/M5)
- Does NOT add Nx Cloud (future enhancement)
- Does NOT change folder structure (M2)
- Does NOT move Storybook stories (M3)
- Does NOT configure module boundaries (M6)
- Does NOT change release process (M7)

### Key Backpack Patterns Preserved

1. **Build System**: Gulp, Babel, Webpack unchanged
2. **Package Structure**: Flat `packages/` directory preserved
3. **Single Published Package**: `@skyscanner/backpack-web` unchanged
4. **CI/CD**: GitHub Actions unchanged
5. **Testing**: Jest configuration unchanged

### Common Pitfalls to Avoid

1. ❌ Enabling TypeScript `composite: true` → ✅ Keep existing TS config
2. ❌ Adding Nx plugins immediately → ✅ Start with vanilla Nx
3. ❌ Enabling Nx Cloud without approval → ✅ Use local cache only
4. ❌ Restructuring folders in M1 → ✅ Wait for M2
5. ❌ Adding `project.json` to components → ✅ Wait for M4

## References

- **M1 Specification**: [M1-nx-initialization.md](milestones/M1-nx-initialization.md)
- **M1 Research**: [M1-research.md](milestones/M1-research.md)
- **Nx Documentation**: [Adding Nx to Existing Project](https://nx.dev/docs/getting-started/start-with-existing-project)
- **Backpack Confluence**: [Nx Adoption One Pager](https://skyscanner.atlassian.net/wiki/spaces/Clover/pages/1430062432)
- **Production Standard**: [TypeScript Monorepos](https://skyscanner.atlassian.net/wiki/spaces/WEAV/pages/1388484149)
