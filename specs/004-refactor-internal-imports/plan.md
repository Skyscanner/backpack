# Implementation Plan: Refactor Internal Source Imports

**Package Branch**: `004-refactor-internal-imports` | **Date**: 2026-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Refactoring specification from `/specs/004-refactor-internal-imports/spec.md`

## Summary

Refactor all internal `src` imports across the Backpack codebase to use public package entry points (`@backpack/bpk-component-xxx`). This involves adding missing exports to component index files, updating import statements in 14+ package files and 82+ example files, and adding an ESLint rule to prevent future violations.

## Technical Context

**Framework**: React 18.3.1 with TypeScript 5.9.2
**Styling**: CSS Modules + Sass (modern API with `@use`)
**Testing**: Jest 30 + Testing Library + jest-axe
**Build Tools**: Webpack 5, Babel 7
**Linting**: ESLint (@skyscanner/eslint-config-skyscanner), Stylelint
**Component Library**: Backpack Design System (Monorepo)
**Package Manager**: npm >=10.7.0
**Node Version**: >=18.20.4
**Path Aliases**: `@backpack/*` → `packages/*` (configured in Jest and TypeScript)
**Constraints**: Must follow Backpack constitution and architecture decisions
**Scale/Scope**: 6 component index updates, 14+ package file updates, 82+ example file updates

## Constitution Check

*GATE: Must pass before implementation begins.*

### Core Principles Compliance

- [x] **Component-First Architecture**: Maintaining package structure in `packages/bpk-component-[name]/`
- [x] **Naming Conventions**: No naming changes required
- [x] **License Headers**: No new files created requiring headers
- [x] **Module Encapsulation**: This refactoring enforces proper encapsulation
- [x] **TypeScript**: All imports will maintain TypeScript compatibility
- [x] **SemVer**: PATCH version - no breaking changes
- [x] **Backward Compatibility**: Public APIs unchanged

### Technology Compliance

- [x] **Path Aliases**: Using `@backpack/*` path aliases
- [x] **No Breaking Changes**: Only import paths change, not runtime behaviour

### Testing Compliance

- [x] **Unit Tests**: Existing tests will verify refactoring correctness
- [x] **TypeScript**: Compilation will validate imports

## Project Structure

### Documentation (this feature)

```text
specs/004-refactor-internal-imports/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Affected Files

```text
packages/
├── bpk-component-text/index.ts                    # Add exports: Tag, TextStyle
├── bpk-component-calendar/index.ts                # Add exports: format
├── bpk-component-bubble/index.ts                  # Add named export: BpkBubble
├── bpk-component-popover/index.ts                 # Add named export: BpkPopover
├── bpk-component-image/index.ts                   # Add named export: BpkImage
├── bpk-component-datepicker/src/*-test.tsx        # 3 files - update imports
├── bpk-component-snippet/src/*.tsx                # 2 files - update imports
├── bpk-component-chip-group/src/*.tsx             # 1 file - update imports
├── bpk-component-bottom-sheet/src/*.tsx           # 1 file - update imports
├── bpk-component-price-range/src/*.tsx            # 2 files - update imports
├── bpk-component-navigation-bar/src/*.tsx         # 1 file - update imports
├── bpk-component-overlay/src/*.tsx                # 1 file - update imports
├── bpk-component-navigation-tab-group/src/*.tsx   # 1 file - update imports
└── bpk-component-inset-banner/src/*.tsx           # 3 files - update imports

examples/
└── bpk-component-*/                               # 82+ files - update imports
```

## Complexity Tracking

**No constitution violations. This refactoring improves adherence to API Encapsulation principle.**

## Phase 0: Research & Discovery

**Status**: Complete - see [research.md](./research.md)

### Key Findings

1. **17 import violations** in packages directory across 14 files
2. **82+ files** in examples directory with similar violations
3. **5 component index files** need additional exports
4. **Path aliases** already configured (`@backpack/*`)
5. **No circular dependencies** will be introduced

## Phase 1: Export Updates

### bpk-component-text/index.ts

**Current exports**:
```typescript
export { TEXT_COLORS, TEXT_STYLES } from './src/BpkText';
export { default } from './src/BpkText';
```

**New exports to add**:
```typescript
export { TEXT_COLORS, TEXT_STYLES } from './src/BpkText';
export type { Tag, TextStyle } from './src/BpkText';
export { default } from './src/BpkText';
```

### bpk-component-calendar/index.ts

**New export to add**:
```typescript
export { format } from './src/date-utils';
```

### bpk-component-bubble/index.ts

**Current exports**:
```typescript
export type { BpkBubbleProps } from './src/BpkBubble';
export { default } from './src/BpkBubble';
```

**New exports to add**:
```typescript
export type { BpkBubbleProps } from './src/BpkBubble';
export { default, default as BpkBubble } from './src/BpkBubble';
```

### bpk-component-popover/index.ts

**Current exports**:
```typescript
export type { BpkPopoverProps } from './src/BpkPopover';
export { themeAttributes } from './src/themeAttributes';
export { default } from './src/BpkPopover';
```

**New exports to add**:
```typescript
export type { BpkPopoverProps } from './src/BpkPopover';
export { themeAttributes } from './src/themeAttributes';
export { default, default as BpkPopover } from './src/BpkPopover';
```

### bpk-component-image/index.ts

**Current exports**:
```typescript
export type { BpkBackgroundImageProps } from './src/BpkBackgroundImage';
export { default as BpkBackgroundImage } from './src/BpkBackgroundImage';
export { default as withLazyLoading } from './src/withLazyLoading';
export { default as withLoadingBehavior } from './src/withLoadingBehavior';
export { BORDER_RADIUS_STYLES } from './src/BpkImage';
export { default } from './src/BpkImage';
```

**New exports to add**:
```typescript
export type { BpkBackgroundImageProps } from './src/BpkBackgroundImage';
export { default as BpkBackgroundImage } from './src/BpkBackgroundImage';
export { default as withLazyLoading } from './src/withLazyLoading';
export { default as withLoadingBehavior } from './src/withLoadingBehavior';
export { BORDER_RADIUS_STYLES, default as BpkImage } from './src/BpkImage';
export { default } from './src/BpkImage';
```

## Phase 2: Import Updates (Packages)

### Pattern Replacement

For each file, replace:
```typescript
// Before
import BpkText, { TEXT_STYLES } from '../../bpk-component-text/src/BpkText';

// After
import BpkText, { TEXT_STYLES } from '@backpack/bpk-component-text';
```

### Files to Update

| File | Current Import | New Import |
|------|----------------|------------|
| `bpk-component-datepicker/src/BpkDatepicker-test.tsx` | `import { format } from '../../bpk-component-calendar/src/date-utils'` | `import { format } from '@backpack/bpk-component-calendar'` |
| `bpk-component-datepicker/src/form-test.tsx` | `import { format } from '../../bpk-component-calendar/src/date-utils'` | `import { format } from '@backpack/bpk-component-calendar'` |
| `bpk-component-datepicker/src/accessibility-test.tsx` | `import { format } from '../../bpk-component-calendar/src/date-utils'` | `import { format } from '@backpack/bpk-component-calendar'` |
| `bpk-component-snippet/src/BpkSnippet.tsx` | `import BpkText, { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import BpkText, { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-snippet/src/accessibility-test.tsx` | `import { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-chip-group/src/BpkMultiSelectChipGroup.tsx` | `import BpkText, { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import BpkText, { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-bottom-sheet/src/BpkBottomSheet.tsx` | `import { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-price-range/src/BpkPriceRange.tsx` | `import BpkText, { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import BpkText, { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-price-range/src/BpkPriceMarker.tsx` | `import BpkText, { TEXT_STYLES } from '../../bpk-component-text/src/BpkText'` | `import BpkText, { TEXT_STYLES } from '@backpack/bpk-component-text'` |
| `bpk-component-navigation-bar/src/BpkNavigationBar.tsx` | `import type { Tag, TextStyle } from '../../bpk-component-text/src/BpkText'` | `import type { Tag, TextStyle } from '@backpack/bpk-component-text'` |
| `bpk-component-overlay/src/BpkOverlay.figma.tsx` | `import BpkImage from '../../bpk-component-image/src/BpkImage'` | `import { BpkImage } from '@backpack/bpk-component-image'` |
| `bpk-component-navigation-tab-group/src/BpkNavigationTabGroup.tsx` | `import BpkBubble from '../../bpk-component-bubble/src/BpkBubble'` | `import { BpkBubble } from '@backpack/bpk-component-bubble'` |
| `bpk-component-inset-banner/src/BpkInsetBannerV2/BpkInsetBannerSponsored.tsx` | Multiple imports | Use `@backpack/bpk-component-*` |
| `bpk-component-inset-banner/src/BpkInsetBanner.tsx` | Multiple imports | Use `@backpack/bpk-component-*` |

## Phase 3: Import Updates (Examples)

The examples directory contains 82+ files with similar violations. A batch update script or manual update will be needed.

### Common Patterns to Replace

```typescript
// Before
import X from '../packages/bpk-component-xxx/src/BpkXxx';
import X from '../../packages/bpk-component-xxx/src/BpkXxx';

// After
import X from '@backpack/bpk-component-xxx';
```

## Phase 4: ESLint Configuration

### Add `no-restricted-imports` Rule

Add to ESLint configuration:

```javascript
{
  rules: {
    'no-restricted-imports': ['error', {
      patterns: [
        {
          group: ['**/bpk-component-*/src/*', '../**/bpk-component-*/src/*', '../../**/bpk-component-*/src/*'],
          message: 'Import from the package entry point instead (e.g., @backpack/bpk-component-xxx)'
        }
      ]
    }]
  }
}
```

## Testing Strategy

### Verification Steps

1. **After Phase 1 (Export Updates)**:
   - Run `npm run typecheck` to verify TypeScript compilation
   - Verify no errors in component index files

2. **After Phase 2 (Package Import Updates)**:
   - Run `npm run jest` to verify all tests pass
   - Run `npm run typecheck` to verify TypeScript compilation
   - Run `npm run build` to verify build succeeds

3. **After Phase 3 (Examples Import Updates)**:
   - Run `npm run storybook` to verify examples render correctly
   - Visual inspection of affected stories

4. **After Phase 4 (ESLint Rule)**:
   - Run `npm run lint:js` to verify no violations
   - Test by adding a violating import to confirm ESLint catches it

### Success Validation

```bash
# Verify no remaining violations in packages
grep -r "from ['\"].*bpk-component-.*/src/" packages/ && echo "FAIL: Violations found" || echo "PASS: No violations"

# Verify no remaining violations in examples
grep -r "from ['\"].*bpk-component-.*/src/" examples/ && echo "FAIL: Violations found" || echo "PASS: No violations"
```

## Migration & Versioning

**Version Type**: PATCH

**Rationale**:
- No public API changes
- No runtime behaviour changes
- Only internal import paths modified
- Adding exports is backward compatible

**Breaking Changes**: None

## Dependencies

### Required Before Starting

- Phase 0.2 path aliases must be configured (confirmed: Jest `moduleNameMapper` has `@backpack/*`)
- TypeScript path aliases must be configured (confirmed in Phase 0.2)

### No External Dependencies Required

All changes are internal to the Backpack monorepo.

## Release Checklist

Before merging this refactoring:

- [ ] All component index exports added
- [ ] All package directory imports updated
- [ ] All examples directory imports updated
- [ ] ESLint rule added
- [ ] `npm run typecheck` passes
- [ ] `npm run jest` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes
- [ ] Storybook renders correctly
- [ ] Grep verification shows no remaining violations

## Notes

### Key Implementation Principles

1. **Order matters**: Add exports before updating imports
2. **Test after each phase**: Catch regressions early
3. **Named exports for components**: Allow both default and named imports
4. **Type exports**: Use `export type` for type-only exports

### Common Pitfalls to Avoid

1. ❌ Updating imports before adding exports → TypeScript errors
2. ❌ Missing named export for default components → Import errors
3. ❌ Forgetting type exports → TypeScript errors
4. ❌ Not testing after each phase → Hard to debug failures

## References

- **Specification**: [spec.md](./spec.md)
- **Research**: [research.md](./research.md)
- **Original Implementation Plan**: `docs/implementation-plans/phase-0.3-refactor-internal-imports.md`
- **Constitution**: `.specify/memory/constitution.md` - API Encapsulation principle
