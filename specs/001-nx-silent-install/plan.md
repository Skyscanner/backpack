<!--
==============================================================================
DOCUMENT PURPOSE: Design HOW to implement spec.md requirements (Implementation)
==============================================================================

This plan describes the technical solution for implementing the NX silent
installation. It bridges the gap between "what we need" (spec) and "what we do" (tasks).

FOCUS: HOW
- How to implement the requirements
- What technologies and patterns to use
- How files should be organized

✅ INCLUDE in plan.md:
- Technical approach and architecture decisions
- Configuration file structures with code
- Installation and verification procedures
- File modification details

❌ EXCLUDE from plan.md (belongs in spec.md):
- Requirements explanations and rationale
- User scenarios and acceptance criteria
- Success criteria and measurable outcomes

❌ EXCLUDE from plan.md (belongs in tasks.md):
- Granular task lists with file paths
- Specific commands to run
- Task execution order and dependencies
- Step-by-step instructions

AUTOMATION:
- Auto-generated by `/speckit.plan` from spec.md requirements
- Derives implementation patterns from spec constraints
- Feeds into `/speckit.tasks` for task generation
==============================================================================
-->

# Implementation Plan: NX Silent Installation

**Package Branch**: `001-nx-silent-install` | **Date**: 2026-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Infrastructure specification from `/specs/001-nx-silent-install/spec.md`

**Note**: This is an infrastructure installation task, not a component development task. Standard Backpack component patterns do not apply.

## Summary

Install NX 22.4.0 as a development tool in silent mode without activating any features or modifying existing workflows. Configuration will use the npm preset with empty plugins and cacheableOperations arrays to ensure NX remains passive until explicitly activated in future changes.

## Technical Context

**Package Manager**: npm >=10.7.0
**Node Version**: >=18.20.4
**NX Version**: 22.4.0 (exact)
**Installation Type**: devDependency
**Configuration Approach**: Minimal npm preset with disabled features
**Target Environment**: Development only (not production)
**Existing Build Tools**: Webpack 5, Babel 7, Gulp 5, Jest 30
**Constraints**: Zero functional impact on existing workflows

## Constitution Check

*GATE: Verify alignment with Backpack principles where applicable*

### Applicable Constitution Principles

- [x] **Zero Impact**: Installation must not modify any existing functionality (aligned with constitution's emphasis on stability)
- [x] **Version Pinning**: Exact version 22.4.0 (aligned with dependency management practices)
- [x] **Documentation**: Changes documented in this plan and research.md
- [x] **Testing**: Verification strategy ensures no behavior changes
- [x] **CI Compatibility**: Must pass existing pipeline

### Non-Applicable Constitution Principles

The following constitution principles are specific to component development and do not apply to infrastructure installations:
- Component-First Architecture (N/A - not a component)
- Modern Sass (N/A - no styling)
- Accessibility-First (N/A - not user-facing)
- TypeScript (N/A - configuration only)
- Visual Testing (N/A - no UI)

## Project Structure

### Documentation (this feature)

```text
specs/001-nx-silent-install/
├── spec.md              # Infrastructure specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Files to Modify

```text
/
├── package.json         # Add nx@22.4.0 to devDependencies
├── nx.json              # Create new file with silent configuration
└── .gitignore           # Add .nx/cache and .nx/workspace-data
```

### Files NOT to Modify

**Critical**: These files must NOT be changed:
- All scripts in package.json (scripts section)
- All existing dependencies (only nx added to devDependencies)
- All configuration files (jest, babel, webpack, eslint, stylelint, etc.)
- All source files in packages/
- All CI configuration files

## Complexity Tracking

**No constitution violations**. This infrastructure installation follows Backpack principles of:
- Minimal impact changes
- Exact version pinning
- Comprehensive testing
- Documentation-first approach

## Phase 0: Research & Discovery

**Status**: ✅ Complete

**Deliverable**: [research.md](./research.md)

**Key Findings**:
1. NX npm preset is the correct approach for silent installation
2. Empty plugins and cacheableOperations arrays prevent feature activation
3. Current package.json structure is compatible with NX
4. No dependency conflicts detected
5. .gitignore patterns align with existing conventions

## Phase 1: Implementation Design

Since this is an infrastructure installation rather than component development, Phase 1 focuses on configuration design rather than API design.

### 1.1 Package Installation Design

**Target file**: `package.json`

**Change**: Add nx to devDependencies section

**Implementation**:
```json
{
  "devDependencies": {
    "nx": "22.4.0"
  }
}
```

**Important Notes**:
- Use exact version (no caret or tilde)
- Add to devDependencies, NOT dependencies
- Do NOT modify scripts section
- Do NOT modify any other dependencies

**Installation command**: `npm install nx@22.4.0 --save-dev --save-exact`

### 1.2 NX Configuration Design

**Target file**: `nx.json` (create new file at repository root)

**Implementation**:
```json
{
  "$schema": "./node_modules/nx/schemas/nx-schema.json",
  "extends": "nx/presets/npm.json",
  "affected": {
    "defaultBase": "main"
  },
  "tasksRunnerOptions": {
    "default": {
      "runner": "nx/tasks-runners/default",
      "options": {
        "cacheableOperations": []
      }
    }
  },
  "targetDefaults": {},
  "plugins": []
}
```

**Configuration Explanation**:

1. **`$schema`**: Enables IDE autocomplete and validation
   - Points to NX's JSON schema for IntelliSense support
   - Helps developers understand available options

2. **`extends: "nx/presets/npm.json"`**:
   - Inherits minimal npm preset configuration
   - Treats NX as passive tool, doesn't modify npm scripts
   - Enables NX commands without workflow changes

3. **`affected.defaultBase: "main"`**:
   - Sets "main" as the base branch for NX affected commands
   - Aligns with Backpack's main branch convention
   - Used when running `nx affected` to determine changed projects

4. **`tasksRunnerOptions`**:
   - Configures the default task runner
   - **`cacheableOperations: []`**: CRITICAL - empty array means NO caching
   - This prevents NX from caching any operations
   - Ensures existing scripts run exactly as before

5. **`targetDefaults: {}`**:
   - Empty object means no target configuration
   - Prevents NX from defining default targets for projects
   - Keeps all build/test configuration in package.json scripts

6. **`plugins: []`**: CRITICAL - empty array means NO plugins
   - Prevents NX from auto-detecting projects
   - Prevents NX from modifying build/test behavior
   - Keeps NX completely passive until explicitly configured

**Why This Configuration is "Silent"**:
- No plugins = No auto-detection
- No cacheableOperations = No behavior changes
- npm preset = Respects existing scripts
- Result: NX is installed but completely inactive

### 1.3 Git Ignore Design

**Target file**: `.gitignore`

**Change**: Add NX cache directories

**Implementation**:
```gitignore
# NX cache directories (added 2026-01-27)
.nx/cache
.nx/workspace-data
```

**Placement**: Append to end of .gitignore file

**Rationale**:
- `.nx/cache`: Contains NX's build cache (similar to .sass-cache, /coverage)
- `.nx/workspace-data`: Contains NX's workspace metadata
- Both directories are generated at runtime and should never be committed
- Aligns with existing patterns for build artifacts and cache

**Why Not Ignore Entire .nx Directory**:
- Future configurations might include committed files in .nx/
- Specific entries provide clarity about what's ignored

## Verification Strategy

### Pre-Installation Baseline

**Capture baseline metrics** before making any changes:

1. **Script Output Capture**:
   ```bash
   # Capture test output
   npm test 2>&1 | tee baseline-test.txt

   # Capture lint output
   npm run lint 2>&1 | tee baseline-lint.txt

   # Capture build output
   npm run build 2>&1 | tee baseline-build.txt

   # Capture storybook startup (first 10 seconds)
   timeout 10 npm run storybook 2>&1 | tee baseline-storybook.txt || true
   ```

2. **Timing Capture**:
   ```bash
   # Time test execution
   time npm test > /dev/null 2>&1

   # Time lint execution
   time npm run lint > /dev/null 2>&1

   # Time build execution
   time npm run build > /dev/null 2>&1
   ```

3. **File State Capture**:
   ```bash
   # Backup package.json
   cp package.json package.json.backup

   # Backup .gitignore
   cp .gitignore .gitignore.backup
   ```

### Post-Installation Verification

**Verify changes** after installation:

1. **Installation Verification**:
   ```bash
   # Verify NX version
   npx nx --version
   # Expected output: "22.4.0"

   # Verify NX in package.json
   grep -A 1 '"nx"' package.json
   # Expected: "nx": "22.4.0"

   # Verify nx.json exists
   [ -f nx.json ] && echo "nx.json exists" || echo "ERROR: nx.json missing"

   # Verify nx.json structure
   cat nx.json | jq '.plugins'
   # Expected: []

   cat nx.json | jq '.tasksRunnerOptions.default.options.cacheableOperations'
   # Expected: []
   ```

2. **Git Ignore Verification**:
   ```bash
   # Verify .gitignore entries
   grep -E '\.nx/(cache|workspace-data)' .gitignore
   # Expected: Two lines matching pattern

   # Test git ignore works
   mkdir -p .nx/cache .nx/workspace-data
   touch .nx/cache/test.txt .nx/workspace-data/test.txt
   git status --porcelain | grep '.nx'
   # Expected: No output (files should be ignored)
   ```

3. **Script Behavior Verification**:
   ```bash
   # Run scripts and compare to baseline
   npm test 2>&1 | diff baseline-test.txt -
   # Expected: No significant differences

   npm run lint 2>&1 | diff baseline-lint.txt -
   # Expected: No significant differences

   npm run build 2>&1 | diff baseline-build.txt -
   # Expected: No significant differences
   ```

4. **Timing Verification**:
   ```bash
   # Re-time scripts
   time npm test > /dev/null 2>&1
   # Expected: Within ±5% of baseline

   time npm run lint > /dev/null 2>&1
   # Expected: Within ±5% of baseline

   time npm run build > /dev/null 2>&1
   # Expected: Within ±5% of baseline
   ```

5. **No Scripts Modified**:
   ```bash
   # Verify scripts section unchanged
   diff <(cat package.json.backup | jq '.scripts') <(cat package.json | jq '.scripts')
   # Expected: No differences
   ```

### CI Pipeline Verification

**Test in CI**:
1. Push branch to remote
2. Monitor CI pipeline execution
3. Verify all checks pass
4. Verify no new warnings or errors
5. Verify execution time within acceptable range

**Rollback Criteria** (if any fail):
- Any script behavior changes
- CI pipeline fails
- Script timing increases >10%
- New warnings or errors appear
- package.json scripts modified

**Rollback Procedure**:
```bash
# Remove nx from package.json
npm uninstall nx

# Delete nx.json
rm nx.json

# Restore .gitignore
git restore .gitignore

# Reinstall dependencies
npm install

# Verify rollback
npm test && echo "Rollback successful"
```

## Testing Strategy

### Manual Testing Checklist

**Before Installation**:
- [ ] Capture baseline output for npm test
- [ ] Capture baseline output for npm run lint
- [ ] Capture baseline output for npm run build
- [ ] Capture baseline output for npm run storybook
- [ ] Record timing for all scripts
- [ ] Backup package.json and .gitignore

**After Installation**:
- [ ] Verify `npx nx --version` returns "22.4.0"
- [ ] Verify nx is in devDependencies with exact version
- [ ] Verify nx.json exists with correct structure
- [ ] Verify plugins array is empty
- [ ] Verify cacheableOperations array is empty
- [ ] Verify .gitignore contains .nx/cache entry
- [ ] Verify .gitignore contains .nx/workspace-data entry
- [ ] Run npm test - verify identical behavior
- [ ] Run npm run lint - verify identical behavior
- [ ] Run npm run build - verify identical behavior
- [ ] Run npm run storybook - verify identical behavior
- [ ] Verify timing within ±5% for all scripts
- [ ] Verify no new warnings or errors
- [ ] Verify package.json scripts unchanged
- [ ] Create .nx directories and verify git ignores them

**CI Testing**:
- [ ] Push branch to remote
- [ ] Verify CI pipeline passes
- [ ] Verify no new CI errors or warnings
- [ ] Verify CI timing acceptable

### Automated Testing

**Not applicable** for this infrastructure change. Testing consists of:
- Manual verification of configuration files
- Execution of existing test suites
- CI pipeline validation

No new automated tests required because:
- NX is configured to be completely passive
- Existing tests already verify system behavior
- If existing tests pass, installation is successful

## Documentation Requirements

### README Updates

**No README updates required** because:
- NX is installed silently with no visible impact
- Developers don't need to know NX is present
- Future PRs will document NX features when activated

### Internal Documentation

**Update CHANGELOG** (if Backpack has one):
```markdown
## [Unreleased]

### Infrastructure
- Installed NX 22.4.0 in silent mode for future build optimization
- Added nx.json with minimal configuration (all features disabled)
- Added .nx/cache and .nx/workspace-data to .gitignore
- No impact on existing workflows or scripts
```

### Team Communication

**Notify #backpack Slack channel** after merge:
```
NX 22.4.0 has been installed in silent mode. This has zero impact on your workflow:
- All npm scripts work exactly the same
- No new commands required
- NX features are disabled for now
- Future PRs will gradually activate NX features

If you notice any issues, please report in this thread.
```

## Migration & Versioning

### Version Determination

**This change is**: PATCH version bump for infrastructure

**Rationale**:
- Infrastructure addition with zero functional impact
- No API changes
- No component behavior changes
- No user-facing changes
- Aligns with SemVer PATCH definition (no functionality changes)

**Monorepo Versioning**:
- Backpack uses Monorepo with independent package versioning
- This infrastructure change affects repository level, not individual packages
- Root package.json version can be bumped (currently "0.0.1")
- Individual package versions remain unchanged

### Breaking Changes

**None** - This is explicitly designed to have zero breaking changes.

### Deprecations

**None** - No APIs or features are being deprecated.

### Future Activation Plan

**Post-Installation** (future PRs):
1. **Phase 2**: Enable caching for specific operations (build, test)
2. **Phase 3**: Add project detection plugins
3. **Phase 4**: Migrate some scripts to use NX commands
4. **Phase 5**: Enable NX Cloud (if approved)

**Timeline**: Each phase will be a separate PR with its own testing and validation.

## Release Checklist

Before merging this change:

**Pre-Installation**:
- [x] Research complete (research.md)
- [x] Implementation plan complete (this file)
- [x] Specification validated (requirements.md checklist)
- [x] Baseline metrics captured

**Implementation**:
- [ ] nx@22.4.0 installed in devDependencies
- [ ] nx.json created with correct structure
- [ ] .gitignore updated with NX cache entries
- [ ] No package.json scripts modified
- [ ] No other dependencies modified

**Verification**:
- [ ] `npx nx --version` returns "22.4.0"
- [ ] npm test executes identically to baseline
- [ ] npm run lint executes identically to baseline
- [ ] npm run build executes identically to baseline
- [ ] npm run storybook executes identically to baseline
- [ ] Script timing within ±5% of baseline
- [ ] .nx directories are git-ignored
- [ ] No new warnings or errors

**CI/CD**:
- [ ] Branch pushed to remote
- [ ] CI pipeline passes
- [ ] No CI configuration changes required
- [ ] CI timing acceptable

**Documentation**:
- [ ] Changelog updated (if applicable)
- [ ] Team notified in #backpack Slack

**Post-Merge**:
- [ ] Monitor for issues in first 24 hours
- [ ] Verify no developer reports of problems
- [ ] Baseline metrics documented for future phases

## Rollback Plan

**If verification fails**, execute rollback immediately:

1. **Revert Git Changes**:
   ```bash
   git restore package.json
   git restore .gitignore
   rm nx.json
   npm install
   ```

2. **Manual Rollback** (if commit already pushed):
   ```bash
   # Remove nx from package.json
   npm uninstall nx

   # Delete nx.json
   rm nx.json

   # Restore .gitignore (remove NX entries)
   git restore .gitignore

   # Commit rollback
   git add package.json .gitignore
   git commit -m "Rollback: Remove NX installation"
   git push
   ```

3. **Verify Rollback**:
   ```bash
   # Verify NX removed
   npm list nx
   # Expected: (empty)

   # Verify scripts work
   npm test
   npm run lint
   npm run build
   ```

4. **Post-Rollback**:
   - Document why rollback was necessary
   - Investigate root cause
   - Update plan with findings
   - Re-attempt installation after fixes

## Notes

### Key Patterns to Follow

1. **Exact Version Pinning**: Always use exact version (22.4.0, not ^22.4.0)
2. **Empty Arrays**: plugins: [] and cacheableOperations: [] are CRITICAL
3. **npm Preset**: Use nx/presets/npm.json for minimal integration
4. **No Script Changes**: Never modify package.json scripts section
5. **Git Ignore Specific Dirs**: Ignore .nx/cache and .nx/workspace-data, not entire .nx/

### Common Pitfalls to Avoid

1. ❌ Using caret or tilde version ranges → ✅ Use exact version 22.4.0
2. ❌ Omitting plugins array (uses defaults) → ✅ Explicit empty array plugins: []
3. ❌ Omitting cacheableOperations (enables caching) → ✅ Explicit empty array cacheableOperations: []
4. ❌ Modifying package.json scripts → ✅ Leave scripts unchanged
5. ❌ Using integrated preset → ✅ Use npm preset
6. ❌ Adding NX commands to CI → ✅ Keep CI configuration unchanged
7. ❌ Ignoring entire .nx directory → ✅ Ignore specific subdirectories
8. ❌ Installing as dependency → ✅ Install as devDependency
9. ❌ Skipping baseline metrics → ✅ Capture before installation
10. ❌ Not testing rollback procedure → ✅ Verify rollback works

### Success Indicators

**Installation is successful if**:
- ✅ npx nx --version returns "22.4.0"
- ✅ All existing npm scripts work identically
- ✅ No new warnings or errors appear
- ✅ CI pipeline passes without changes
- ✅ Script timing within acceptable range (±5%)
- ✅ NX cache directories are git-ignored
- ✅ No developer workflow changes required

**Installation should be rolled back if**:
- ❌ Any script behavior changes
- ❌ CI pipeline fails
- ❌ New warnings or errors appear
- ❌ Script timing increases >10%
- ❌ Developer workflows disrupted

## References

- **Feature Spec**: [spec.md](./spec.md)
- **Research**: [research.md](./research.md)
- **Requirements Checklist**: [checklists/requirements.md](./checklists/requirements.md)
- **NX Documentation**: https://nx.dev/getting-started/intro
- **NX npm Preset**: https://nx.dev/recipes/adopting-nx/adding-to-monorepo
- **NX Configuration**: https://nx.dev/reference/nx-json
- **Backpack Constitution**: `.specify/memory/constitution.md`
