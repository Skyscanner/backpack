name: Dev Release

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to publish a dev release from"
        required: true
        type: number
      dry_run:
        description: "Run the full build pipeline without publishing to npm"
        required: false
        type: boolean
        default: false

defaults:
  run:
    shell: bash -l {0}

env:
  CACHE_NAME: node-modules-cache
  PR_COMMENT_MARKER: "<!-- backpack-dev-release -->"

permissions: {}

jobs:
  SecurityCheck:
    name: Validate PR and permissions
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      pr_sha: ${{ steps.validate.outputs.pr_sha }}
    steps:
      - name: Checkout for actions
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          sparse-checkout: .github/actions

      - name: Validate PR security
        id: validate
        uses: ./.github/actions/pr-security-validation
        with:
          pr_number: ${{ inputs.pr_number }}

      - name: Add or update failure comment on PR
        if: failure()
        uses: ./.github/actions/upsert-pr-comment
        with:
          pr_number: ${{ inputs.pr_number }}
          marker: ${{ env.PR_COMMENT_MARKER }}
          body: |
            ${{ env.PR_COMMENT_MARKER }}
            ### Dev Release Failed

            The dev release workflow failed a security check. See the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            Triggered by @${{ github.actor }}.

  DevRelease:
    name: Build and publish dev release
    runs-on: ubuntu-latest
    environment: Publishing
    needs: [SecurityCheck]
    permissions:
      contents: read
    outputs:
      dev_version: ${{ steps.version.outputs.dev_version }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.SecurityCheck.outputs.pr_sha }}
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: ".nvmrc"
          registry-url: 'https://registry.npmjs.org'

      - name: Cache npm dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules/
            packages/node_modules/
          key: ${{ env.CACHE_NAME }}-${{ hashFiles('package-lock.json', 'packages/package-lock.json') }}

      - name: Install dependencies
        if: ${{ steps.npm-cache.outputs.cache-hit != 'true' }}
        run: npm ci

      - name: Determine dev version
        id: version
        run: |
          BASE_VERSION=$(git describe --tags --abbrev=0 --exclude='*-*' HEAD)
          DEV_VERSION="${BASE_VERSION}-dev-v${GITHUB_RUN_ID}.${GITHUB_RUN_ATTEMPT}"
          echo "dev_version=${DEV_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Dev version: ${DEV_VERSION}"

      - name: Transpile
        run: npm run transpile

      - name: Publish dev release to npm
        if: ${{ inputs.dry_run != true }}
        run: |
          cd dist
          npm version $DEV_VERSION --no-git-tag-version
          npm publish --tag dev
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          DEV_VERSION: ${{ steps.version.outputs.dev_version }}

  ReportResults:
    name: Report results on PR
    runs-on: ubuntu-latest
    needs: [SecurityCheck, DevRelease]
    if: always() && needs.SecurityCheck.result == 'success'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout for actions
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          sparse-checkout: .github/actions

      - name: Build comment body
        id: build-body
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          DEV_VERSION: ${{ needs.DevRelease.outputs.dev_version }}
          PR_SHA: ${{ needs.SecurityCheck.outputs.pr_sha }}
          BUILD_RESULT: ${{ needs.DevRelease.result }}
          DRY_RUN: ${{ inputs.dry_run }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          PR_COMMENT_MARKER: ${{ env.PR_COMMENT_MARKER }}
        with:
          script: |
            const marker = process.env.PR_COMMENT_MARKER;
            let body;

            if (process.env.BUILD_RESULT === 'success' && process.env.DRY_RUN === 'true') {
              body = [
                marker,
                `### Dev Release Dry Run Successful`,
                '',
                `**Version (not published):** \`${process.env.DEV_VERSION}\``,
                '',
                'The build and transpilation completed successfully. No package was published to npm.',
                '',
                'Run the workflow again without dry run to publish this version.',
                '',
                `Triggered from commit ${process.env.PR_SHA} by @${context.actor}.`,
              ].join('\n');
            } else if (process.env.BUILD_RESULT === 'success') {
              body = [
                marker,
                `### Dev Release Published`,
                '',
                `**Version:** \`${process.env.DEV_VERSION}\``,
                '',
                '**Install with:**',
                '```',
                `npm install @skyscanner/backpack-web@${process.env.DEV_VERSION}`,
                '```',
                '',
                `You can also use the dev tag to install the latest dev release:`,
                '```',
                'npm install @skyscanner/backpack-web@dev',
                '```',
                '',
                `Published from commit ${process.env.PR_SHA} by @${context.actor}.`,
              ].join('\n');
            } else {
              body = [
                marker,
                `### Dev Release Failed`,
                '',
                `The dev release workflow failed. See the [workflow run](https://github.com/${process.env.REPO}/actions/runs/${process.env.RUN_ID}) for details.`,
                '',
                `Triggered by @${context.actor}.`,
              ].join('\n');
            }

            core.setOutput('body', body);

      - name: Update PR comment with results
        uses: ./.github/actions/upsert-pr-comment
        with:
          pr_number: ${{ inputs.pr_number }}
          marker: ${{ env.PR_COMMENT_MARKER }}
          body: ${{ steps.build-body.outputs.body }}
          github_token: ${{ steps.app-token.outputs.token }}
