# Layout PoC 优化：决策摘要（基于性能数据 + 成本/风险）

本文件用于回答：**在不同业务前提下，layout PoC 这类“减少 runtime CSS-in-JS 工作量”的优化是否值得推进**；并给出**当前阶段的推荐结论**。

> 性能对比数据详见：`test/README.md`

## 1) 我们在评估什么

layout PoC 的目标本质上是降低以下成本：

- **运行时 CPU**：style prop 解析 / Emotion 生成与插入 / 运行时样式分支处理等
- **样式管线成本**：Style recalculation / Layout 触发与放大
- **滚动/交互稳定性**：降低长任务与偶发卡顿（tail jank）

但它也带来成本：

- **代码量与复杂度上升**：双路径（CSS vars + Chakra fallback）、API 约束、调试成本、边缘 case（响应式/RTL/主题/SSR）
- **推广/迁移成本**：需要逐步迁移使用方式、治理不合规用法、维护文档与规范

## 2) 关键前提：什么情况下“值得推进”

### A. 业务痛点是 **tail**（偶发严重卡顿/掉帧/不响应）

**优先推进**。原因：
- 这类优化的收益往往主要体现在 **p95/outlier**（最差体验显著改善），而不是 p50/p75。
- tail 改善对用户主观体验的杠杆很大（“偶发卡死”消失通常价值>均值提升）。

**决策信号**：
- p95/outlier（`scroll_ms`、`raf.maxFrameMs`）稳定显著下降
- trace 显示 Chakra/Emotion 相关工作或样式重算峰值明显降低

### B. 业务痛点是 **均值/常态体验**（大多数用户都觉得慢/卡）

只有当数据能证明 **p50/p75** 有明显改善时才值得推进；否则谨慎。

**决策信号**：
- `toggle_ms` / `scroll_ms` 的 p50/p75 显著下降（并且多次复现）
- 不只是消除极端 outlier，而是整体分布左移

### C. 业务当前没有明显性能痛点（包括 tail 和均值都不突出）

通常 **不建议此阶段扩面推进**：
- 收益难以转化为业务价值
- 成本（维护/复杂度/迁移）是确定的

适合保留为 PoC/技术储备，并设立触发条件。

## 3) 本次数据说明了什么（结合 `test/README.md`）

- **p50/p75 基本持平**：在 `toggle_ms`、`scroll_ms` 上两分支差异很小，说明常态路径收益有限。
- **tail/outlier 有改善**：control 分支在滚动场景出现极端 outlier（例如 `large_list_scroll` 的 `scroll_ms p95`、`raf.maxFrameMs p95` 极大），candidate 分支基本无此类 outlier。

=> 这批数据更支持“**提升尾部稳定性**”，而不是“**提升平均性能**”。

## 4) 当前推荐结论（结合你提供的前提）

你已确认：**当前业务并没有 tail 痛点**。

因此当前阶段我推荐：

- **不建议把 layout PoC 优化扩面推进到更大范围**（ROI 不高）
- **保留 PoC 与 benchmark 能力**（已具备可复现测试与对比脚本），作为后续性能问题出现时的“快速验证与回归工具”

## 5) 建议的后续触发条件（何时重新开启推进）

当出现以下任一情况，可重新评估并考虑推进：

- 线上出现：列表页/结果页 **滚动掉帧、交互不响应、偶发卡死**（tail 指标恶化）
- 产品策略变化：要覆盖更低端设备、更复杂结果卡片、更深组件树（更容易触发运行时样式成本）
- 监控/告警：INP/长任务/滚动期间 style recalculation 峰值显著升高

届时建议做：

- 用同一套 benchmark + trace 复测（保持可比性）
- 明确目标：tail 还是均值（选择相应指标作为门槛）


