# Technical Implementation Guidance: Backpack Layout Migration to Chakra UI + PandaCSS

> **Note**: This is a **spike** implementation exploring the migration of Backpack layout components to Chakra UI 3.0 with PandaCSS for zero-runtime CSS generation.

## Table of Contents

1. [Overview](#overview)
2. [Architecture Overview](#architecture-overview)
3. [What Changed](#what-changed)
4. [How It Works](#how-it-works)
5. [Build Process](#build-process)
6. [Implementation Details](#implementation-details)
7. [File Structure](#file-structure)
8. [Migration Checklist](#migration-checklist)
9. [Troubleshooting](#troubleshooting)

## Overview

This spike migrates Backpack layout components (`BpkBox`, `BpkFlex`, `BpkGrid`, `BpkStack`) from traditional SCSS-based styling to a Chakra UI facade pattern with PandaCSS for zero-runtime CSS generation.

### Key Goals

- ✅ **Zero-runtime CSS**: Use PandaCSS to generate static CSS at build time
- ✅ **Design System Enforcement**: Strict token validation to prevent arbitrary values
- ✅ **Type Safety**: Full TypeScript support with compile-time token checking
- ✅ **Backward Compatibility**: Maintain similar API surface while enforcing design tokens
- ✅ **Props Separation**: Clear distinction between common props and component-specific props

## Architecture Overview

### High-Level Flow

```
Consumer Component
    ↓
BpkBox/BpkFlex/etc (Facade)
    ↓
processBpkProps() - Token Validation & Conversion
    ↓
Chakra UI Primitive (Box/Flex/etc)
    ↓
PandaCSS (Build Time) - CSS Generation
    ↓
Static CSS Output (shipped with package)
```

### Key Components

1.  **Facade Components** (`BpkBox.tsx`, `BpkFlex.tsx`, etc.): React components that wrap Chakra UI primitives
2.  **Token Processor** (`tokenUtils.ts`): Validates and converts Backpack tokens to CSS values
3.  **Theme System** (`theme.ts`): Configures Chakra UI system via `createSystem` and `defineConfig`
4.  **Type System** (`tokens.ts`, `commonProps.ts`, `types.ts`): Enforces token usage at compile time
5.  **Provider** (`BpkProvider.tsx`): Provides Chakra UI context with Backpack theme
6.  **Color Mapping** (`colorMapping.ts`): Maps Backpack color tokens to RGB values

## What Changed

### New Files Created

```
packages/bpk-component-layout/
├── src/
│   ├── BpkBox.tsx              # Box component facade
│   ├── BpkFlex.tsx             # Flex component facade
│   ├── BpkGrid.tsx             # Grid component facade
│   ├── BpkStack.tsx            # Stack components facade (Stack, HStack, VStack)
│   ├── BpkProvider.tsx         # Chakra UI provider with Backpack theme
│   ├── tokens.ts               # Token definitions and constants
│   ├── tokenUtils.ts           # Token validation and conversion logic
│   ├── theme.ts                # Chakra UI theme configuration
│   ├── colorMapping.ts         # Color token to RGB value mapping
│   ├── commonProps.ts          # Common prop type definitions
│   ├── types.ts                # Component-specific prop types
│   └── styled-system/          # Generated by PandaCSS (git-ignored)
├── panda.config.ts             # PandaCSS configuration
├── index.ts                    # Package exports
├── .gitignore                  # Ignores styled-system directory
├── README.md                   # User-facing documentation
├── STYLE.md                    # Styling approach documentation
├── TECHNICAL_GUIDANCE.md       # This file
└── BUNDLE_SIZE_ANALYSIS.md     # Bundle size impact analysis
```

### Key Changes

1.  **Removed `className` prop**: Explicitly excluded to prevent style overrides.
2.  **Token-only values**: Spacing and color props only accept Backpack tokens.
3.  **Type-safe API**: TypeScript enforces token usage at compile time.
4.  **Zero-runtime CSS**: PandaCSS generates static CSS at build time.
5.  **Props separation**: Clear distinction between `BpkCommonLayoutProps` and component-specific props.
6.  **Pre-generated styles**: `styled-system` directory is generated and shipped with the package.

## How It Works

### 1. Component Usage Flow

```tsx
// Consumer writes:
<BpkBox p={BpkSpacing.Base} bg={BpkColor.Canvas} />

// Step 1: BpkBox receives props
export const BpkBox = ({ children, ...props }: BpkBoxProps) => {
  // Step 2: Process props (validate & convert tokens)
  const processedProps = processBpkProps(props);

  // Step 3: Pass to Chakra UI Box
  return <Box {...processedProps}>{children}</Box>;
};
```

### 2. Token Processing Pipeline

```typescript
// tokenUtils.ts - processBpkProps()
function processBpkProps(props) {
  // 1. Remove className
  const { className, ...propsWithoutClassName } = props;

  // 2. Process spacing props (convert tokens to rem values)
  let processed = processSpacingProps(propsWithoutClassName);
  // Example: 'bpk-spacing-base' → '1rem'

  // 3. Process color props (convert tokens to RGB values)
  processed = processColorProps(processed);
  // Example: 'bpk-canvas-day' → 'rgb(255, 255, 255)'

  return processed;
}
```

### 3. Responsive Override Support

The system supports Chakra UI's responsive object syntax with simplified breakpoint keys (`base`, `mobile`, `tablet`, `desktop`, `large-desktop`). The `processResponsiveValue` function recursively converts tokens within these objects.

```tsx
<BpkBox
  bg={{
    base: BpkColor.Canvas,
    tablet: BpkColor.SurfaceHighlight
  }}
/>
```

The recursive processing ensures that nested objects and arrays are properly handled at all levels.

### 4. Token Resolution

*   **Spacing**: Mapped in `theme.ts` using hardcoded rem values (e.g., `bpk-spacing-base` -> `1rem`). These values match Backpack foundations SCSS function outputs.
*   **Colors**: Mapped in `colorMapping.ts` using RGB values (e.g., `bpk-canvas-day` -> `rgb(255, 255, 255)`). This direct mapping ensures Chakra UI 3.0 applies colors correctly without needing complex theme lookups.
*   **Breakpoints**: Mapped in `theme.ts` from Backpack foundations breakpoint queries to simplified keys.

### 5. Type Safety

TypeScript enforces token usage via:
- `BpkSpacingValue`: Only `BpkSpacingToken` or `${number}%`
- `BpkColorValue`: Only `BpkColorToken` or `'transparent' | 'currentColor'`
- `BpkStackProps`: Specifically overrides `spacing` prop to strictly require `BpkSpacingValue`

### 6. Props Architecture

The props system is structured in two layers:

1. **Common Props** (`BpkCommonLayoutProps`):
   - Extends `BpkSpacingProps` and `BpkColorProps`
   - Explicitly excludes `className` (set to `never`)
   - Available on all layout components

2. **Component-Specific Props**:
   - `BpkBoxSpecificProps`: Box-specific props (e.g., `as`, `display`)
   - `BpkFlexSpecificProps`: Flex-specific props (e.g., `direction`, `align`)
   - `BpkGridSpecificProps`: Grid-specific props (e.g., `templateColumns`)
   - `BpkStackSpecificProps`: Stack-specific props with enforced `spacing`

Each component's props interface combines common and specific props:
```typescript
export interface BpkBoxProps extends BpkCommonLayoutProps, BpkBoxSpecificProps {
  children?: ReactNode;
}
```

## Build Process

### Build Steps

1.  **Generate Static CSS**:
    `npm run codegen` runs `panda codegen`, generating the styling engine into `src/styled-system`.

2.  **Compile & Copy**:
    `npm run build` (or the monorepo's `npm run transpile`) compiles the TypeScript code. Crucially, it copies the `src/styled-system` directory to `dist/bpk-component-layout/src/styled-system` via the `transpile:copy-utils` script.

### Build Integration

The root `package.json` includes a `build:layout` script that ensures `bpk-component-layout` is built as part of the main build process:

```json
{
  "scripts": {
    "build": "run-s build:*",
    "build:layout": "npm run build --prefix packages/bpk-component-layout"
  }
}
```

### Build Integration for Consumers

Consumers do **not** need to run PandaCSS generation. The package ships with pre-generated styles.

1.  **Install**: `npm install @skyscanner/backpack-web/bpk-component-layout`
2.  **Import CSS**:
    ```typescript
    import '@skyscanner/backpack-web/bpk-component-layout/dist/bpk-component-layout/src/styled-system/styles.css';
    ```
    *(Note: exact path depends on final dist structure)*
3.  **Wrap App**: Use `<BpkProvider>`.

## Implementation Details

### File-by-File Breakdown

#### Component Files

*   **`src/BpkBox.tsx`**: Facade wrapping Chakra `Box`. Calls `processBpkProps`.
*   **`src/BpkFlex.tsx`**: Facade wrapping Chakra `Flex`. Calls `processBpkProps`.
*   **`src/BpkGrid.tsx`**: Facade wrapping Chakra `Grid`. Calls `processBpkProps`.
*   **`src/BpkStack.tsx`**: Facades wrapping Chakra `Stack`, `HStack`, `VStack`. Calls `processBpkProps`.

#### Core Logic Files

*   **`src/tokenUtils.ts`**:
    - Core logic for validation (`isValidSpacingValue`, `isValidColorValue`)
    - Conversion functions (`convertBpkSpacingToChakra`, `convertBpkColorToChakra`)
    - Recursive responsive value processing (`processResponsiveValue`)
    - Main processing function (`processBpkProps`)

*   **`src/theme.ts`**:
    - Defines the Chakra theme configuration using `defineConfig`
    - Maps Backpack spacing tokens to rem values
    - Maps Backpack breakpoints to simplified keys
    - Exports `createBpkConfig()` function

*   **`src/colorMapping.ts`**:
    - Centralized mapping of Backpack color tokens to RGB values
    - Used by `convertBpkColorToChakra` for direct color value resolution

*   **`src/tokens.ts`**:
    - Defines strict constants (`BpkSpacing`, `BpkColor`, `BpkBreakpoint`)
    - Defines types (`BpkSpacingToken`, `BpkColorToken`, etc.)
    - Validation functions (`isValidSpacingValue`, `isValidColorValue`, `isPercentage`)

#### Type Definition Files

*   **`src/commonProps.ts`**:
    - Defines `BpkSpacingProps` (all spacing-related props)
    - Defines `BpkColorProps` (all color-related props)
    - Defines `BpkCommonLayoutProps` (combines spacing + color, excludes className)

*   **`src/types.ts`**:
    - Defines component-specific prop types (`BpkBoxSpecificProps`, etc.)
    - Defines main component prop interfaces (`BpkBoxProps`, etc.)
    - Uses `RemoveCommonProps<T>` utility to exclude common props from Chakra types

#### Provider

*   **`src/BpkProvider.tsx`**:
    - Uses `createSystem(defaultConfig, createBpkConfig())` to create custom system
    - Provides Chakra UI context via `ChakraProvider` with `value` prop (v3 API)

#### Configuration

*   **`panda.config.ts`**:
    - Configures PandaCSS output directory (`src/styled-system`)
    - Uses Chakra UI preset
    - Includes source files for CSS generation

*   **`index.ts`**:
    - Exports all components and types
    - Exports token objects and types
    - Exports common and specific prop types

## File Structure

```
packages/bpk-component-layout/
├── src/
│   ├── BpkBox.tsx
│   ├── BpkFlex.tsx
│   ├── BpkGrid.tsx
│   ├── BpkStack.tsx
│   ├── BpkProvider.tsx
│   ├── tokens.ts
│   ├── tokenUtils.ts
│   ├── theme.ts
│   ├── colorMapping.ts
│   ├── commonProps.ts
│   ├── types.ts
│   └── styled-system/          # Generated by PandaCSS (git-ignored)
│       ├── css/
│       ├── jsx/
│       ├── patterns/
│       ├── recipes/
│       ├── tokens/
│       └── types/
├── panda.config.ts
├── index.ts
├── .gitignore                  # Ignores src/styled-system
├── package.json
├── README.md
├── STYLE.md
├── TECHNICAL_GUIDANCE.md
└── BUNDLE_SIZE_ANALYSIS.md
```

## Migration Checklist

### For Maintainers

- [ ] Ensure `npm run build` generates `src/styled-system/`
- [ ] Verify `transpile:copy-utils` copies `styled-system` to `dist/`
- [ ] Test that all components render correctly in Storybook
- [ ] Verify TypeScript types are exported correctly
- [ ] Check that `className` prop is properly excluded
- [ ] Validate token conversion works for all tokens
- [ ] Test responsive overrides with all breakpoints
- [ ] Verify CSS import path in documentation

### For Consumers

- [ ] Install package: `npm install @skyscanner/backpack-web/bpk-component-layout`
- [ ] Import CSS file from dist
- [ ] Wrap app with `<BpkProvider>`
- [ ] Replace direct CSS values with Backpack tokens
- [ ] Remove `className` props from layout components
- [ ] Update responsive breakpoint keys if needed
- [ ] Test all layout components in your application

## Troubleshooting

### Common Issues

1.  **"Cannot read properties of undefined (reading '_config')"**:
    *   **Cause**: `ChakraProvider` in v3 needs a `value` prop with a system, not a `theme` prop.
    *   **Solution**: `BpkProvider` handles this internally using `createSystem`. Ensure you are using `BpkProvider` and not `ChakraProvider` directly.

2.  **Styles not applying**:
    *   **Cause**: Missing CSS import.
    *   **Solution**: Import the generated `styles.css` from the package's dist folder.

3.  **TypeScript errors on props**:
    *   **Cause**: Passing raw strings/numbers to spacing/color props.
    *   **Solution**: Use `BpkSpacing.*` or `BpkColor.*` constants.

4.  **"className prop is not allowed"**:
    *   **Cause**: Trying to pass `className` to layout components.
    *   **Solution**: Use specific style props instead (e.g., `p`, `bg`, `color`).

5.  **Token values not converting**:
    *   **Cause**: Token not found in mapping.
    *   **Solution**: Check that the token exists in `BpkSpacing` or `BpkColor` objects. Check console warnings in development mode.

6.  **Responsive overrides not working**:
    *   **Cause**: Using incorrect breakpoint keys.
    *   **Solution**: Use simplified keys (`base`, `mobile`, `tablet`, `desktop`, `large-desktop`) instead of full Backpack breakpoint strings.

7.  **Build errors with styled-system**:
    *   **Cause**: `styled-system` directory not generated.
    *   **Solution**: Run `npm run codegen` in `bpk-component-layout` directory.

8.  **Missing styled-system in dist**:
    *   **Cause**: `transpile:copy-utils` script not copying the directory.
    *   **Solution**: Check that `scripts/transpilation/copy-utils.js` includes the copy logic for `styled-system`.

## Token Processing Details

### Spacing Token Conversion

Spacing tokens are converted using a hardcoded map in `theme.ts`:

```typescript
const spacingMap: Record<string, { value: string }> = {
  'bpk-spacing-none': { value: '0' },
  'bpk-spacing-sm': { value: '.25rem' },
  'bpk-spacing-base': { value: '1rem' },
  'bpk-spacing-md': { value: '.5rem' },
  'bpk-spacing-lg': { value: '1.5rem' },
  'bpk-spacing-xl': { value: '2rem' },
  'bpk-spacing-xxl': { value: '2.5rem' },
};
```

These values match the outputs of Backpack foundations SCSS functions.

### Color Token Conversion

Color tokens are converted using `colorMapping.ts` which maps tokens to RGB values:

```typescript
export const BACKPACK_COLOR_MAPPING: Record<string, string> = {
  'bpk-text-primary-day': 'rgb(22, 22, 22)',
  'bpk-canvas-day': 'rgb(255, 255, 255)',
  // ...
};
```

The RGB values are passed directly to Chakra UI, which accepts standard CSS color formats.

### Breakpoint Mapping

Breakpoints are mapped from Backpack foundations queries to simplified keys:

```typescript
const breakpointMap: Record<string, string> = {
  'small-mobile': breakpoints.breakpointQuerySmallMobile,
  'mobile': breakpoints.breakpointQueryMobile,
  'small-tablet': breakpoints.breakpointQuerySmallTablet,
  'tablet': breakpoints.breakpointQueryTablet,
  'desktop': breakpoints.breakpointQueryAboveTablet,
  'large-desktop': breakpoints.breakpointQueryAboveDesktop,
};
```

These simplified keys are used in responsive object syntax for better developer experience.
